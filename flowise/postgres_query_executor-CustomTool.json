{
  "name": "postgres_query_executor",
  "description": "Execute PostgreSQL queries to retrieve data from the database. Use for fetching user data, workflow history, bot statistics, or any data analysis queries. READ-ONLY queries only.",
  "color": "linear-gradient(rgb(48, 103, 163), rgb(32, 69, 109))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"query\",\"description\":\"SQL query to execute (SELECT only, no modifications)\",\"type\":\"string\",\"required\":true},{\"id\":1,\"property\":\"params\",\"description\":\"Query parameters as JSON array (optional)\",\"type\":\"string\",\"required\":false}]",
  "func": "/*\n* Execute PostgreSQL queries safely\n* Only SELECT queries are allowed for safety\n* Available tables:\n* - users: Telegram bot users\n* - user_events: User action logs\n* - menu_items: Bot menu structure\n* - n8n workflow tables\n*/\n\nconst { Client } = require('pg');\n\n// Validate query is SELECT only\nconst trimmedQuery = $query.trim().toLowerCase();\nif (!trimmedQuery.startsWith('select')) {\n    return 'Error: Only SELECT queries are allowed for safety. Use n8n workflows for data modifications.';\n}\n\n// Check for dangerous keywords\nconst dangerousKeywords = ['drop', 'delete', 'update', 'insert', 'truncate', 'alter', 'create'];\nfor (const keyword of dangerousKeywords) {\n    if (trimmedQuery.includes(keyword)) {\n        return `Error: Query contains forbidden keyword '${keyword}'. Only SELECT queries allowed.`;\n    }\n}\n\nconst client = new Client({\n    host: $vars.postgres_host || 'postgres',\n    port: $vars.postgres_port || 5432,\n    database: $vars.postgres_db || 'postgres',\n    user: $vars.postgres_user || 'postgres',\n    password: $vars.postgres_password\n});\n\ntry {\n    await client.connect();\n    \n    let queryParams = [];\n    if ($params) {\n        try {\n            queryParams = JSON.parse($params);\n        } catch (e) {\n            queryParams = [$params];\n        }\n    }\n    \n    const result = await client.query($query, queryParams);\n    \n    await client.end();\n    \n    return JSON.stringify({\n        rowCount: result.rowCount,\n        rows: result.rows,\n        fields: result.fields.map(f => ({ name: f.name, type: f.dataTypeID }))\n    }, null, 2);\n    \n} catch (error) {\n    if (client) {\n        await client.end().catch(() => {});\n    }\n    console.error('PostgreSQL query error:', error);\n    return `Error executing query: ${error.message}`;\n}"
}
