{
  "name": "telegram_bot_manager",
  "description": "Manage Telegram bot operations: send messages, get user info, update menu items, check bot statistics. Integrates with tg-bot service.",
  "color": "linear-gradient(rgb(42, 171, 238), rgb(28, 140, 196))",
  "iconSrc": "",
  "schema": "[{\"id\":0,\"property\":\"action\",\"description\":\"Action to perform: send_message, get_user, get_stats, list_users, update_menu\",\"type\":\"string\",\"required\":true},{\"id\":1,\"property\":\"params\",\"description\":\"Action parameters as JSON (e.g. {\\\"chat_id\\\": 123, \\\"text\\\": \\\"Hello\\\"})\",\"type\":\"string\",\"required\":false}]",
  "func": "/*\n* Telegram Bot Manager Tool\n* Actions:\n* - send_message: Send message to user {chat_id, text}\n* - get_user: Get user info {telegram_id}\n* - get_stats: Get bot usage statistics\n* - list_users: List all bot users with filters {role, limit}\n* - update_menu: Update menu item {key, label, enabled}\n*/\n\nconst fetch = require('node-fetch');\nconst { Client } = require('pg');\n\nlet params = {};\nif ($params) {\n    try {\n        params = JSON.parse($params);\n    } catch (e) {\n        return `Error: Invalid JSON in params: ${e.message}`;\n    }\n}\n\n// For database operations\nconst dbClient = new Client({\n    host: $vars.postgres_host || 'postgres',\n    port: 5432,\n    database: $vars.postgres_db || 'postgres',\n    user: $vars.postgres_user || 'postgres',\n    password: $vars.postgres_password\n});\n\ntry {\n    switch ($action) {\n        case 'send_message':\n            if (!params.chat_id || !params.text) {\n                return 'Error: send_message requires chat_id and text parameters';\n            }\n            // Send via Telegram Bot API\n            const botToken = $vars.telegram_bot_token;\n            if (!botToken) {\n                return 'Error: TELEGRAM_BOT_TOKEN not configured';\n            }\n            const telegramUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;\n            const telegramResponse = await fetch(telegramUrl, {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    chat_id: params.chat_id,\n                    text: params.text,\n                    parse_mode: params.parse_mode || 'HTML'\n                })\n            });\n            const telegramResult = await telegramResponse.json();\n            return JSON.stringify(telegramResult, null, 2);\n            \n        case 'get_user':\n            await dbClient.connect();\n            const userQuery = 'SELECT * FROM users WHERE telegram_id = $1';\n            const userResult = await dbClient.query(userQuery, [params.telegram_id]);\n            await dbClient.end();\n            if (userResult.rows.length === 0) {\n                return `User with telegram_id ${params.telegram_id} not found`;\n            }\n            return JSON.stringify(userResult.rows[0], null, 2);\n            \n        case 'get_stats':\n            await dbClient.connect();\n            const statsQueries = [\n                'SELECT COUNT(*) as total_users FROM users',\n                'SELECT COUNT(*) as total_events FROM user_events',\n                'SELECT role, COUNT(*) as count FROM users GROUP BY role',\n                'SELECT COUNT(*) as active_today FROM user_events WHERE created_at >= CURRENT_DATE'\n            ];\n            const stats = {};\n            for (let i = 0; i < statsQueries.length; i++) {\n                const result = await dbClient.query(statsQueries[i]);\n                stats[`query_${i}`] = result.rows;\n            }\n            await dbClient.end();\n            return JSON.stringify(stats, null, 2);\n            \n        case 'list_users':\n            await dbClient.connect();\n            let listQuery = 'SELECT telegram_id, username, first_name, role, created_at FROM users';\n            const queryParams = [];\n            if (params.role) {\n                listQuery += ' WHERE role = $1';\n                queryParams.push(params.role);\n            }\n            listQuery += ' ORDER BY created_at DESC';\n            if (params.limit) {\n                listQuery += ` LIMIT ${parseInt(params.limit)}`;\n            } else {\n                listQuery += ' LIMIT 50';\n            }\n            const listResult = await dbClient.query(listQuery, queryParams);\n            await dbClient.end();\n            return JSON.stringify({ count: listResult.rowCount, users: listResult.rows }, null, 2);\n            \n        case 'update_menu':\n            await dbClient.connect();\n            if (!params.key) {\n                await dbClient.end();\n                return 'Error: update_menu requires key parameter';\n            }\n            const updateFields = [];\n            const updateValues = [];\n            let paramIndex = 1;\n            if (params.label) {\n                updateFields.push(`label = $${paramIndex++}`);\n                updateValues.push(params.label);\n            }\n            if (params.enabled !== undefined) {\n                updateFields.push(`enabled = $${paramIndex++}`);\n                updateValues.push(params.enabled);\n            }\n            if (updateFields.length === 0) {\n                await dbClient.end();\n                return 'Error: No fields to update (label, enabled)';\n            }\n            updateValues.push(params.key);\n            const updateQuery = `UPDATE menu_items SET ${updateFields.join(', ')} WHERE key = $${paramIndex} RETURNING *`;\n            const updateResult = await dbClient.query(updateQuery, updateValues);\n            await dbClient.end();\n            if (updateResult.rowCount === 0) {\n                return `Menu item with key '${params.key}' not found`;\n            }\n            return JSON.stringify(updateResult.rows[0], null, 2);\n            \n        default:\n            return `Error: Unknown action '${$action}'. Available: send_message, get_user, get_stats, list_users, update_menu`;\n    }\n} catch (error) {\n    if (dbClient) {\n        await dbClient.end().catch(() => {});\n    }\n    console.error('Telegram bot manager error:', error);\n    return `Error: ${error.message}`;\n}"
}
